<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Search Results</title>
		
		<!-- Universal stylesheet for all pages -->
		<link rel="stylesheet" href="../assets/css/universal_styles.css">
		
		<!-- Stylesheet for this specific page -->
		<link rel="stylesheet" href="../assets/css/legacy_modding_minecraft_wiki_styles.css">
		
		<!-- Page title -->
		<title>Search results</title>
		
		<!-- No favicon for now. -->
		<link rel="icon" type="image/x-icon" href="assets/images/">
		
		<!-- Universal javascript for all pages -->
		<script src="../assets/javascript/universal.js" defer></script>
	</head>
	<body>
		<nav class="top-navigation-bar">
			<a href="/">Back to the wiki home page</a>
			<!-- If this anchor tag gets deleted the navbar disappears, so it will remain here for now. -->
		</nav>
		
		<br>
		<br>
		<br>
		
		<div class="wiki-search">
			<input type="text" id="global-search" placeholder="Search the whole website" class="wiki-search-bar">
			<button id="global-search-button">Search</button>
		</div>
		
		<br>
		
		<div class="information-section">
			<h1 id="search-title">Search Results</h1>
			
			<hr>
			
			<div id="status"></div>
			<div id="results"></div>

			<script>
				const PAGES_TO_INDEX = [
					{ title: "Home", url: "/" },
					{ title: "1.7.10 Special cases wiki", url: "/1.7.10_special/" },
					{ title: "1.12.2 Forge wiki", url: "/1.12.2_forge/" },
					{ title: "Contribution Guidelines", url: "/contribution_guidelines/" }
					// More pages go here
				];

				let INDEX = [];

				async function buildIndex() {
					const statusEl = document.getElementById("status");
					statusEl.textContent = "Building search index...";

					const promises = PAGES_TO_INDEX.map(async page => {
						try {
							const res = await fetch(page.url);
							const html = await res.text();

							const tmp = document.createElement("div");
							tmp.innerHTML = html;

							const spaPages = tmp.querySelectorAll(".wiki-page");

							if (spaPages.length > 0) {
								spaPages.forEach(spa => {
									const id = spa.id;
									const originalText = spa.textContent;
									const lowerText = originalText.toLowerCase();

									INDEX.push({
										title: `${page.title}#${id}`,
										url: `${page.url}#${id}`,
										content: originalText,
										contentLower: lowerText
									});
								});
							} else {
								const spaHTML = spa.innerHTML;
								const originalText = spaHTML.replace(/<[^>]*>/g, " ");
								const lowerText = originalText.toLowerCase();

								INDEX.push({
									title: page.title,
									url: page.url,
									content: originalText,
									contentLower: lowerText
								});
							}
						} catch (e) {
							console.error("Failed to index", page.url, e);
						}
					});

					await Promise.all(promises);
					statusEl.textContent = "";
				}

				function performSearch(query) {
					const resultsContainer = document.getElementById("results");
					const titleEl = document.getElementById("search-title");
					const q = query.toLowerCase().trim();

					if (!q) {
						titleEl.textContent = "Search Results";
						resultsContainer.innerHTML = "<p>No search query provided.</p>";
						return;
					}

					titleEl.innerHTML = `Search Results for "${query}"`;

					const matches = INDEX.filter(page => page.contentLower.includes(q));

					if (matches.length === 0) {
						resultsContainer.innerHTML = `<p>No results found for "${query}".</p>`;
						return;
					}

					resultsContainer.innerHTML = matches.map(page => {
						const snippets = extractAllSnippets(page.content, q);

						return `
							<div class="search-result">
								<h3><a href="${page.url}">${page.title}</a></h3>
								${snippets.map(s => `<p>${s}</p>`).join("")}
							</div>
						`;
					}).join("");
				}
				
				function extractSnippet(originalText, queryLower) {
					const lowerText = originalText.toLowerCase();
					const index = lowerText.indexOf(queryLower);
					if (index === -1) return "";

					const start = Math.max(0, index - 75);
					const end = Math.min(originalText.length, index + queryLower.length + 75);

					let snippet = originalText.substring(start, end);

					// Highlight matches (case-insensitive)
					const regex = new RegExp(queryLower, "gi");
					snippet = snippet.replace(regex, match => `<mark>${match}</mark>`);

					if (start > 0) snippet = "..." + snippet;
					snippet = snippet + "...";

					return snippet;
				}
				
				function extractAllSnippets(originalText, queryLower) {
					const lowerText = originalText.toLowerCase();
					const snippets = [];
					let index = 0;

					while (true) {
						index = lowerText.indexOf(queryLower, index);
						if (index === -1) break;

						// Expand snippet window
						const start = Math.max(0, index - 75);
						const end = Math.min(originalText.length, index + queryLower.length + 75);

						let snippet = originalText.substring(start, end);

						// Highlight ALL occurrences
						const regex = new RegExp(queryLower, "gi");
						snippet = snippet.replace(regex, match => `<mark>${match}</mark>`);

						// Add ellipses
						if (start > 0) snippet = "..." + snippet;
						if (end < originalText.length) snippet = snippet + "...";
						else snippet = snippet + "..."; // force trailing ellipsis

						snippets.push(snippet);

						index += queryLower.length;
					}

					return snippets;
				}

				async function init() {
					const params = new URLSearchParams(window.location.search);
					const query = params.get("q") || "";

					await buildIndex();
					performSearch(query);
				}
				
				init();
			</script>
		</div>
		
		<br>
		
		<footer>
			<p>&copy; 2026-2026 wikiformoddinglegacyminecraftjava All rights reserved.</p>
			<p>Website first created on February 4, 2026</p>
			<p>Website first published on February 4, 2026</p>
			<p>Website last updated on <span id="site-last-updated"></span></p>
		</footer>
	</body>
</html>
